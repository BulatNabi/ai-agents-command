name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e

            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com | sh
              systemctl enable docker
              systemctl start docker
            fi

            # Install Nginx if not present
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              apt-get update
              apt-get install -y nginx
              systemctl enable nginx
            fi

            # Open firewall ports
            if command -v ufw &> /dev/null; then
              ufw allow 80/tcp
              ufw allow 443/tcp
              ufw allow 8888/tcp
              ufw --force enable || true
            fi

            # Also try iptables if ufw not available
            iptables -I INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || true
            iptables -I INPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null || true

            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi

            # Install Claude CLI if not present
            if ! command -v claude &> /dev/null; then
              echo "Installing Claude CLI..."
              npm install -g @anthropic-ai/claude-code
            fi

            # Install Python3 and pip if not present
            if ! command -v pip3 &> /dev/null; then
              echo "Installing Python3 pip..."
              apt-get update
              apt-get install -y python3-pip python3-venv
            fi

            # Create app directory
            mkdir -p /opt/ai-agents-command
            cd /opt/ai-agents-command

            # Clone or pull latest code
            if [ -d ".git" ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/BulatNabi/ai-agents-command.git .
            fi

            # Build frontend (empty VITE_API_URL = use relative paths via nginx proxy)
            cd /opt/ai-agents-command/frontend
            npm ci
            VITE_API_URL= npm run build

            # Copy frontend build to nginx
            rm -rf /var/www/ai-agents
            mkdir -p /var/www/ai-agents
            cp -r dist/* /var/www/ai-agents/

            # Create nginx config
            cat > /etc/nginx/sites-available/ai-agents << 'NGINXEOF'
            server {
                listen 80;
                server_name 89.208.103.242;

                # Frontend
                location / {
                    root /var/www/ai-agents;
                    index index.html;
                    try_files $uri $uri/ /index.html;
                }

                # Backend API proxy
                location /api/ {
                    proxy_pass http://127.0.0.1:8888/api/v1/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                    proxy_redirect off;
                }

                # Health check
                location /health {
                    proxy_pass http://127.0.0.1:8888/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                }
            }
            NGINXEOF

            # Enable site
            ln -sf /etc/nginx/sites-available/ai-agents /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default

            # Test and reload nginx
            nginx -t
            systemctl reload nginx

            # Setup backend (run directly, not in Docker, so it can access Claude CLI)
            cd /opt/ai-agents-command/backend

            # Create .env for backend
            echo 'DEBUG=false' > .env
            echo 'CORS_ORIGINS=["http://89.208.103.242","http://localhost:5173"]' >> .env
            echo 'GITHUB_ORG=BulatNabi' >> .env

            # Find Claude CLI path and add to .env
            CLAUDE_PATH=$(which claude || echo "/usr/local/bin/claude")
            echo "CLAUDE_CLI_PATH=$CLAUDE_PATH" >> .env
            echo "Found Claude at: $CLAUDE_PATH"

            # Create and activate virtual environment
            python3 -m venv /opt/ai-agents-command/venv
            source /opt/ai-agents-command/venv/bin/activate

            # Install Python dependencies
            pip install -r requirements.txt

            # Stop existing backend if running
            pkill -f "uvicorn app.main:app" 2>/dev/null || true
            sleep 2

            # Start backend with nohup using venv python
            nohup /opt/ai-agents-command/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8888 > /var/log/ai-agents-backend.log 2>&1 &

            sleep 3
            echo "Backend started. Checking if running..."
            pgrep -f "uvicorn app.main:app" && echo "Backend is running!" || echo "Backend failed to start"

            echo "=== Deployment Complete ==="
            echo "Frontend: http://89.208.103.242"
            echo "API: http://89.208.103.242/api/"
