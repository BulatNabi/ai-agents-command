name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e

            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com | sh
              systemctl enable docker
              systemctl start docker
            fi

            # Install Nginx if not present
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              apt-get update
              apt-get install -y nginx
              systemctl enable nginx
            fi

            # Open firewall ports
            if command -v ufw &> /dev/null; then
              ufw allow 80/tcp
              ufw allow 443/tcp
              ufw allow 8888/tcp
              ufw --force enable || true
            fi

            # Also try iptables if ufw not available
            iptables -I INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || true
            iptables -I INPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null || true

            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi

            # Create app directory
            mkdir -p /opt/ai-agents-command
            cd /opt/ai-agents-command

            # Clone or pull latest code
            if [ -d ".git" ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/BulatNabi/ai-agents-command.git .
            fi

            # Build frontend
            cd /opt/ai-agents-command/frontend
            npm ci
            VITE_API_URL=http://89.208.103.242:8888 npm run build

            # Copy frontend build to nginx
            rm -rf /var/www/ai-agents
            mkdir -p /var/www/ai-agents
            cp -r dist/* /var/www/ai-agents/

            # Create nginx config
            cat > /etc/nginx/sites-available/ai-agents << 'NGINXEOF'
            server {
                listen 80;
                server_name 89.208.103.242;

                # Frontend
                location / {
                    root /var/www/ai-agents;
                    index index.html;
                    try_files $uri $uri/ /index.html;
                }

                # Backend API proxy
                location /api/ {
                    proxy_pass http://127.0.0.1:8888/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                }

                # Health check
                location /health {
                    proxy_pass http://127.0.0.1:8888/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                }
            }
            NGINXEOF

            # Enable site
            ln -sf /etc/nginx/sites-available/ai-agents /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default

            # Test and reload nginx
            nginx -t
            systemctl reload nginx

            # Build and run backend
            cd /opt/ai-agents-command/backend

            # Create .env for backend
            cat > .env << 'ENVEOF'
            DEBUG=false
            CORS_ORIGINS=["http://89.208.103.242","http://localhost:5173"]
            GITHUB_TOKEN=
            GITHUB_ORG=BulatNabi
            CLAUDE_CLI_PATH=claude
            ENVEOF

            docker build -t ai-agents-backend .

            # Stop and remove existing container
            docker stop ai-agents-backend 2>/dev/null || true
            docker rm ai-agents-backend 2>/dev/null || true

            # Run backend container
            docker run -d \
              --name ai-agents-backend \
              --restart unless-stopped \
              -p 8888:8000 \
              --env-file .env \
              ai-agents-backend

            echo "=== Deployment Complete ==="
            echo "Frontend: http://89.208.103.242"
            echo "API: http://89.208.103.242/api/"
            docker ps | grep ai-agents-backend
